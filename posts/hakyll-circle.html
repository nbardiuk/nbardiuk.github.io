<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title> How to Hakyll CircleCI 2.0 @  Nazarii's blog</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/default.css" />
    <meta name="google-site-verification" content="1eqgeS8dNQrx_2L4hO1e5FzIq3AbotzOVmASihAsJVA"/>
    <link href="https://webmention.io/nazarii.bardiuk.com/xmlrpc" rel="pingback"/>
    <link href="https://webmention.io/nazarii.bardiuk.com/webmention" rel="webmention"/>
</head>
<body><header>
    <div class="logo">
        <a href="/">Nazarii's blog</a>
    </div>
</header>
<main role="main">
<article class="h-entry">
    <link class="u-url" href="https://nazarii.bardiuk.com/posts/hakyll-circle.html">
    <link rel="author" class="p-author h-card" href="/"/>
    <section class="header">
        <h1 class="p-name">How to Hakyll CircleCI 2.0</h1>
        Posted on 
        <time class="dt-published" datetime="2018-08-19T00:00:00Z">
            August 19, 2018
        </time>
    </section>
    <section class="e-content" >
        <p>This post documents my
<a href="https://github.com/nbardiuk/nbardiuk.github.io/blob/a2745429997f4f66bd488e330f694c60c4624194/.circleci/config.yml">CircleCI configuration</a>
that builds Hakyll site and publishes it to GitHub pages.</p>
<p>It is inspired by configurations found on the Internet.</p>
<ul>
<li><a href="https://pbrisbin.com/posts/haskell_project_checklist/#circleyml">Example of caching dependencies for stack</a> by Pat Brisbin</li>
<li><a href="https://github.com/haskellweekly/haskellweekly.github.io/blob/b9e2f0e70aa0f8fe8d2a427fa6c64ec41a2b7965/tools/deploy.hs">Old publishing script of haskellweekly blog</a> by Taylor Fausak</li>
<li><a href="https://www.stackbuilders.com/news/dr-hakyll-create-a-github-page-with-hakyll-and-circleci">Guide to publish GitHub page with Hakyll and CircleCI 1.0</a> by Juan Pedro Villa</li>
</ul>
<h2 id="overview">Overview</h2>
<!-- vim-markdown-toc GFM -->
<ul>
<li><a href="#use-fpcomplete-docker-image">Use FPComplete docker image</a></li>
<li><a href="#cache-compiled-dependencies">Cache compiled dependencies</a></li>
<li><a href="#generate-content">Generate content</a></li>
<li><a href="#push-_site-content-to-github-pages">Push <code>_site</code> content to GitHub pages</a></li>
<li><a href="#referrers">Referrers</a></li>
</ul>
<!-- vim-markdown-toc -->
<h2 id="use-fpcomplete-docker-image">Use FPComplete docker image</h2>
<p>Docker is the simplest <a href="https://circleci.com/docs/2.0/executor-types/#overview">executor type</a> on CircleCI.</p>
<p>This configuration reuses <a href="https://hub.docker.com/r/fpco/stack-build/">FPComplete&rsquo;s image</a> with stack to avoid custom installation scripts.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-yaml" data-lang="yaml"><span style="font-weight:bold">docker</span>:
  - <span style="font-weight:bold">image</span>: fpco/stack-build:lts
</code></pre></div><h2 id="cache-compiled-dependencies">Cache compiled dependencies</h2>
<p>The job is going to recompile all dependencies on every build because it is
using clean docker image.</p>
<p>It takes around 20 minutes to build template Hakyll blog.
With <a href="https://circleci.com/docs/2.0/caching/">caching configuration</a> building
time drops to less than a minute.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-yaml" data-lang="yaml">- <span style="font-weight:bold">restore_cache</span>:
    <span style="font-weight:bold">name</span>: Restore Cached Dependencies
    <span style="font-weight:bold">keys</span>:
      <span style="font-style:italic"># find a cache for the same stack.yaml</span>
      - stack-{{ .Branch }}-{{ checksum <span style="font-style:italic">&#34;stack.yaml&#34;</span> }}
      <span style="font-style:italic"># when missing reuse from the same branch</span>
      - stack-{{ .Branch }}<span style="font-style:italic">-
</span><span style="font-style:italic">     </span><span style="font-style:italic"> </span><span style="font-style:italic"># when missing reuse the latest cache</span>
      - stack-
- <span style="font-weight:bold">run</span>:
    <span style="font-weight:bold">name</span>: Resolve/Update Dependencies
    <span style="font-weight:bold">command</span>: stack setup
    <span style="font-weight:bold">command</span>: stack build --dependencies-only
- <span style="font-weight:bold">save_cache</span>:
    <span style="font-weight:bold">name</span>: Cache Dependencies
    <span style="font-weight:bold">key</span>: stack-{{ .Branch }}-{{ checksum <span style="font-style:italic">&#34;stack.yaml&#34;</span> }}
    <span style="font-weight:bold">paths</span>:
      - ~/.stack
      - ./.stack-work
</code></pre></div><h2 id="generate-content">Generate content</h2>
<p>Builds <code>site</code> application and uses it to generate static content</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-yaml" data-lang="yaml">- <span style="font-weight:bold">run</span>:
    <span style="font-weight:bold">name</span>: Build Site App
    <span style="font-weight:bold">command</span>: stack build --pedantic
- <span style="font-weight:bold">run</span>:
    <span style="font-weight:bold">name</span>: Generate Static Site
    <span style="font-weight:bold">command</span>: stack exec site build
</code></pre></div><h2 id="push-_site-content-to-github-pages">Push <code>_site</code> content to GitHub pages</h2>
<p>Here <code>master</code> branch is not used for version control but rather as production
environment so it makes more sense to keep it clean and wipe previous site
content by <code>git push --force</code></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-yaml" data-lang="yaml">- <span style="font-weight:bold">run</span>:
    <span style="font-weight:bold">name</span>: Publish GitHub Pages
    <span style="font-weight:bold">working_directory</span>: <span style="font-style:italic">&#39;./_site&#39;</span>
    <span style="font-weight:bold">command</span>: <span style="font-style:italic">|
</span><span style="font-style:italic">     </span><span style="font-style:italic"> </span><span style="font-style:italic"># initalize repo</span>
      git init
      git config user.name  <span style="font-style:italic">&#39;CircleCI&#39;</span>
      git config user.email <span style="font-style:italic">&#39;job@circleci.com&#39;</span>
      <span style="font-style:italic"># add generated files</span>
      git add .
      git commit -m <span style="font-style:italic">&#34;publish $CIRCLE_SHA1 [ci skip]&#34;</span>
      <span style="font-style:italic"># push to pages branch</span>
      git remote add origin <span style="font-style:italic">&#34;$CIRCLE_REPOSITORY_URL&#34;</span>
      git push --force origin master
</code></pre></div><h2 id="referrers">Referrers</h2>
<ul>
<li><a href="https://mastodon.social/@Nbardiuk/100577686469743725">nbardiuk@mastodon</a></li>
<li><a href="https://twitter.com/nbardiuk/status/1031156387185930240">nbardiuk@twitter</a></li>
<li><a href="https://www.reddit.com/r/haskell/comments/98jtii/how_to_hakyll_circleci_20/">r/haskell</a></li>
<li><a href="https://haskellweekly.news/issues/121.html">Hasell Weekly 121</a></li>
</ul>

    </section>
</article>

        </main><footer class="h-card">
    © 2014–2020
    <span class="p-name">Nazarii Bardiuk</span>
    <link class="u-url" href="https://nazarii.bardiu.com" rel="me"/>
    <link class="u-email" href="mailto:nazarii@bardiuk.com" rel="me"/>
    <link href="https://github.com/nbardiuk" rel="me"/>
    <link href="https://twitter.com/nbardiuk" rel="me"/>
    <link href="https://mastodon.social/@Nbardiuk" rel="me"/>
</footer>
</body>
</html>
